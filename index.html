<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>ustarp969GAME – SmoothTouch Edition</title>
<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#cfeeff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  #wrap{position:fixed;inset:0}
  #bg,#stage{
    position:absolute;top:0;left:0;right:0;bottom:0;margin:auto;
    touch-action:none;display:block;
  }
  #bg{z-index:1}
  #stage{z-index:2}
  #hud{position:fixed;top:10px;left:10px;right:10px;z-index:3;display:flex;justify-content:space-between;align-items:center;color:#123}
  #tip{font-size:13px;opacity:.75;margin-left:8px}
  button{border:none;border-radius:12px;padding:10px 14px;font-weight:800}
  #drop{background:#ff5c97;color:#fff;margin-right:6px}
  #retry{background:#79c6ff;color:#003}
  #title{position:fixed;inset:auto 0 40px 0;text-align:center;font-weight:900;font-size:28px;color:#fff;text-shadow:0 3px 10px #0004;z-index:1;pointer-events:none}
  #gameover{
    position:fixed;inset:0;display:none;place-items:center;z-index:4;
    background:rgba(0,0,0,.55);color:#fff;font-weight:900;font-size:40px;text-shadow:0 3px 10px #000;
  }
  #soundGate{
    position:fixed;inset:0;z-index:5;display:grid;place-items:center;
    background:rgba(0,0,0,.35);color:#fff;font-weight:900;font-size:24px;text-shadow:0 2px 8px #000;
  }
</style>
</head>
<body>
<div id="hud">
  <div><span id="score">SCORE 0</span><span id="tip">　タップでサウンド解放 / スワイプで移動 → DROPボタンで落とす</span></div>
  <div>
    <button id="drop">DROP</button>
    <button id="retry">Retry</button>
  </div>
</div>

<div id="wrap">
  <canvas id="bg" width="420" height="720"></canvas>
  <canvas id="stage" width="420" height="720"></canvas>
</div>
<div id="title">ustarp969GAME</div>
<div id="gameover">GAME OVER</div>
<div id="soundGate">TAP TO ENABLE SOUND</div>

<script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
<script>
/* ===== 背景アニメ ===== */
const W=420,H=720;
const bg=document.getElementById('bg');
const bctx=bg.getContext('2d');
function drawBG(t=0){
  const g=bctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,"#bfe7ff");g.addColorStop(0.55,"#e9f6ff");g.addColorStop(1,"#ffe3f0");
  bctx.fillStyle=g;bctx.fillRect(0,0,W,H);
  bctx.globalAlpha=.6;
  for(let i=0;i<5;i++){
    const x=(t*12+i*120)%(W+160)-80,y=60+i*46;
    bctx.fillStyle="#fff";
    bctx.beginPath();
    bctx.ellipse(x,y,38,18,0,0,Math.PI*2);
    bctx.ellipse(x+24,y+6,26,12,0,0,Math.PI*2);
    bctx.ellipse(x-22,y+8,22,10,0,0,Math.PI*2);
    bctx.fill();
  }
  bctx.globalAlpha=1;
  bctx.save();
  bctx.translate(W/2,H-42);
  bctx.fillStyle="rgba(0,0,0,.12)";
  bctx.font="900 22px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif";
  bctx.textAlign="center";
  bctx.fillText("ustarp969GAME",0,0);
  bctx.restore();
}
(function loop(){drawBG(performance.now()/1000);requestAnimationFrame(loop);})();

/* ===== サウンド ===== */
let actx=null,master=null,bgmTimer=null;
function ensureAudio(){
  if(actx)return;
  const AC=window.AudioContext||window.webkitAudioContext;
  actx=new AC();
  master=actx.createGain();master.gain.value=.14;master.connect(actx.destination);
}
async function unlockAudioOnce(){
  ensureAudio();
  try{await actx.resume();}catch(e){}
  try{
    const buf=actx.createBuffer(1,1,22050);
    const src=actx.createBufferSource();
    src.buffer=buf;src.connect(master);src.start(0);
  }catch(e){}
}
function tone(freq,len=.25,vol=.16,type='triangle'){
  if(!actx)ensureAudio();
  if(actx.state==='suspended')actx.resume();
  const o=actx.createOscillator(),g=actx.createGain();
  o.type=type;o.frequency.value=freq;o.connect(g);g.connect(master);
  const t=actx.currentTime;
  g.gain.setValueAtTime(0.0001,t);
  g.gain.exponentialRampToValueAtTime(vol,t+.03);
  g.gain.exponentialRampToValueAtTime(0.0001,t+len);
  o.start(t);o.stop(t+len+.02);
}
function startBGM(){
  if(!actx)ensureAudio();
  if(bgmTimer)return;
  const base=261.63;const seq=[0,2,4,7,9,7,4,2,0,5,7,9,12,9,7,5];
  let i=0;
  const loop=()=>{tone(base*Math.pow(2,seq[i%seq.length]/12),.32,.12,'sine');
  if(i%4===0)tone(base/2,.5,.09,'triangle');
  i++;bgmTimer=setTimeout(loop,340);};
  loop();
}
function stopBGM(){if(bgmTimer){clearTimeout(bgmTimer);bgmTimer=null;}}
const SFX={
  drop(){tone(660,.10,.22,'square');tone(990,.08,.18,'triangle');},
  land(){tone(220,.08,.18,'triangle');setTimeout(()=>tone(180,.12,.14,'triangle'),60);},
  over(){stopBGM();tone(392,.30,.22,'sawtooth');setTimeout(()=>tone(220,.55,.20,'sawtooth'),300);}
};
const gate=document.getElementById('soundGate');
async function startSound(){
  await unlockAudioOnce();
  startBGM();
  gate.style.display='none';
}
window.addEventListener('pointerdown',startSound,{once:true});

/* ===== Matter.js ===== */
const {Engine,Render,Runner,World,Bodies,Body,Events,Composite,Vertices}=Matter;
const stage=document.getElementById('stage');
const engine=Engine.create({gravity:{x:0,y:.95}});
const render=Render.create({canvas:stage,engine,options:{width:W,height:H,wireframes:false,background:'transparent'}});
Render.run(render);
Runner.run(Runner.create(),engine);

/* ===== バイク台 ===== */
const bikeVerts=Vertices.fromPath("0 0  70 -16  110 -8  140 -18  170 -6  200 -12  230 0  180 16  120 14  60 10");
const bikeY=560;
const bike=Bodies.fromVertices(W/2,bikeY,bikeVerts,{isStatic:true,render:{fillStyle:"#2f2f2f",strokeStyle:"#000",lineWidth:2}});
const wheelL=Bodies.circle(W/2-60,590,24,{isStatic:true,render:{fillStyle:"#4a4a4a",strokeStyle:"#000",lineWidth:2}});
const wheelR=Bodies.circle(W/2+90,590,24,{isStatic:true,render:{fillStyle:"#4a4a4a",strokeStyle:"#000",lineWidth:2}});
World.add(engine.world,[bike,wheelL,wheelR]);
World.add(engine.world,[
  Bodies.rectangle(-20,H/2,40,H,{isStatic:true,render:{visible:false}}),
  Bodies.rectangle(W+20,H/2,40,H,{isStatic:true,render:{visible:false}})
]);

/* ===== 画像プリロード ===== */
const ASSETS=["I.PNG","O.PNG","T.PNG","L.PNG","J.PNG","S.PNG"];
function preload(list){
  return Promise.all(list.map(name=>new Promise(res=>{
    const img=new Image();
    img.onload=()=>res({ok:true,name,img,w:img.naturalWidth,h:img.naturalHeight,src:"./"+name});
    img.onerror=()=>res({ok:false,name,w:80,h:100,src:"./"+name});
    img.src="./"+name+"?v=3";
  })));
}

/* ===== ゲーム ===== */
const MAX_W=56;
let photos=[],qi=0,cur=null,followX=W/2,score=0,over=false;
const scoreEl=document.getElementById('score');
const overEl=document.getElementById('gameover');
function setScore(n){score=n;scoreEl.textContent="SCORE "+score;}
function makeBody(p,x,y,isStatic=true){
  const ratio=p.h/p.w;
  const w=Math.min(MAX_W,p.w||MAX_W),h=w*ratio;
  const opt={isStatic,restitution:0.08,friction:0.7};
  opt.render=p.ok?{sprite:{texture:p.src,xScale:w/p.w,yScale:h/p.h}}:{fillStyle:"#ffb3d1",strokeStyle:"#c03",lineWidth:1.5};
  return Bodies.rectangle(x,y,w,h,opt);
}
function spawn(){
  if(over)return;
  const p=photos[qi++%photos.length];
  cur=makeBody(p,followX,80,true);
  World.add(engine.world,cur);
}
function drop(){
  if(!cur||over)return;
  SFX.drop();
  Body.setStatic(cur,false);
  cur=null;setScore(score+1);
  setTimeout(spawn,600);
}
function reset(){
  Composite.allBodies(engine.world).forEach(b=>{
    if(![bike,wheelL,wheelR].includes(b)&&!b.isStatic)World.remove(engine.world,b);
    if(![bike,wheelL,wheelR].includes(b)&&b.isStatic)World.remove(engine.world,b);
  });
  qi=0;over=false;setScore(0);overEl.style.display='none';startBGM();spawn();
}

/* ===== 入力 ===== */
// スワイプ操作を強化（スマホ対応）
let isDragging=false;
stage.addEventListener('pointerdown',e=>{
  isDragging=true;
});
stage.addEventListener('pointerup',()=>{isDragging=false;});
stage.addEventListener('pointermove',e=>{
  if(!isDragging)return;
  const r=stage.getBoundingClientRect();
  followX=Math.max(30,Math.min(W-30,(e.clientX-r.left)*(W/r.width)));
});
document.getElementById('drop').onclick=drop;
document.getElementById('retry').onclick=reset;

/* ===== 衝突とゲームオーバー ===== */
Events.on(engine,'collisionStart',ev=>{
  ev.pairs.forEach(p=>{
    const a=p.bodyA,b=p.bodyB;
    const dynamicA=!a.isStatic,dynamicB=!b.isStatic;
    const touchesPlatform=(a===bike||a===wheelL||a===wheelR||a.isStatic)||(b===bike||b===wheelL||b===wheelR||b.isStatic);
    if((dynamicA||dynamicB)&&touchesPlatform)SFX.land();
  });
});
Events.on(engine,'afterUpdate',()=>{
  const fallen=Composite.allBodies(engine.world).find(b=>!b.isStatic&&b.position.y>660);
  if(fallen&&!over){over=true;overEl.style.display='grid';SFX.over();}
  if(cur&&cur.isStatic){
    Body.setPosition(cur,{x:cur.position.x+(followX-cur.position.x)*0.25,y:cur.position.y});
  }
});

/* ===== スタート ===== */
preload(ASSETS).then(list=>{photos=list;setScore(0);spawn();});
</script>
</body>
</html>
