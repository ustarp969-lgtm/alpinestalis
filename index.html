<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>Alpinestalis – Sky Tetris</title>
<style>
  html,body {
    margin:0;
    height:100%;
    overflow:hidden;
  }
  body {
    background: url("sky.png") no-repeat center center fixed;
    background-size: cover; /* 空のイラストを全画面に敷く */
  }
  #wrap {display:flex;justify-content:center;align-items:center;height:100%}
  canvas {background: rgba(0,0,0,0.3);border-radius:12px}
  #ui {
    position:fixed;top:10px;left:12px;right:12px;
    display:flex;justify-content:space-between;align-items:center;
    color:#fff;font-weight:700;text-shadow:0 2px 6px rgba(0,0,0,.6);
  }
</style>
</head>
<body>
<div id="ui">
  <div id="score">SCORE 0</div>
</div>
<div id="wrap">
  <canvas id="cv" width="300" height="600"></canvas>
</div>

<!-- BGM -->
<audio id="bgm" src="bgm.mp3" loop></audio>

<script>
/* ===== 基本設定 ===== */
const COLS=10, ROWS=20, SIZE=30;
const cv=document.getElementById("cv"), ctx=cv.getContext("2d");
cv.width=COLS*SIZE; cv.height=ROWS*SIZE;

let board = Array.from({length:ROWS},()=>Array(COLS).fill(0));
let score=0;

/* ===== 形と色 ===== */
const SHAPES = {
  I: [[1,1,1,1]],
  O: [[1,1],[1,1]],
  T: [[0,1,0],[1,1,1]],
  L: [[1,0,0],[1,1,1]],
  J: [[0,0,1],[1,1,1]],
  S: [[0,1,1],[1,1,0]]
};
const COLORS = {I:"#39e",O:"#fc3",T:"#c4f",L:"#f80",J:"#06f",S:"#0f6"};
const TYPES = Object.keys(SHAPES);

/* ===== ブロック画像 ===== */
const BLOCK_IMG_SRC = {
  I: "I.PNG",
  O: "O.PNG",
  T: "T.PNG",
  L: "L.PNG",
  J: "J.PNG",
  S: "S.PNG"
};
const BLOCK_IMG = {};
for (const k in BLOCK_IMG_SRC) {
  const im = new Image();
  im.src = BLOCK_IMG_SRC[k] + "?v=1"; // キャッシュ避け
  BLOCK_IMG[k] = im;
}

/* ===== ピース生成 ===== */
function newPiece(){
  const t=TYPES[(Math.random()*TYPES.length)|0];
  return {t, m:SHAPES[t].map(r=>r.slice()), x:3, y:0};
}
let cur=newPiece();

/* ===== 回転・衝突 ===== */
function rot(m){
  const h=m.length,w=m[0].length;
  const r=[...Array(w)].map(()=>Array(h).fill(0));
  for(let y=0;y<h;y++)for(let x=0;x<w;x++) r[x][h-1-y]=m[y][x];
  return r;
}
function coll(m,px,py){
  for(let y=0;y<m.length;y++)for(let x=0;x<m[0].length;x++){
    if(!m[y][x]) continue;
    const nx=px+x, ny=py+y;
    if(nx<0||nx>=COLS||ny>=ROWS) return true;
    if(ny>=0 && board[ny][nx]) return true;
  }
  return false;
}

/* ===== 固定・ライン消去 ===== */
function merge(){
  for(let y=0;y<cur.m.length;y++)for(let x=0;x<cur.m[0].length;x++){
    if(cur.m[y][x]) board[cur.y+y][cur.x+x]=cur.t;
  }
  for(let y=ROWS-1;y>=0;y--){
    if(board[y].every(v=>v)){
      board.splice(y,1);
      board.unshift(Array(COLS).fill(0));
      score+=100; y++;
    }
  }
  document.getElementById('score').textContent=`SCORE ${score}`;
  cur=newPiece();
  if(coll(cur.m,cur.x,cur.y)){ // Game Over
    board=Array.from({length:ROWS},()=>Array(COLS).fill(0));
    score=0; document.getElementById('score').textContent='SCORE 0';
  }
}

/* ===== 描画 ===== */
function drawCell(x,y,t){
  const gx=x*SIZE, gy=y*SIZE;
  const im = BLOCK_IMG[t];
  if (im && im.complete && im.naturalWidth) {
    ctx.drawImage(im, gx+2, gy+2, SIZE-4, SIZE-4);
  } else {
    ctx.fillStyle = COLORS[t]||"#888";
    ctx.fillRect(gx+1, gy+1, SIZE-2, SIZE-2);
  }
}
function render(){
  ctx.clearRect(0,0,cv.width,cv.height);
  for(let y=0;y<ROWS;y++)for(let x=0;x<COLS;x++) if(board[y][x]) drawCell(x,y,board[y][x]);
  for(let y=0;y<cur.m.length;y++)for(let x=0;x<cur.m[0].length;x++) if(cur.m[y][x]) drawCell(cur.x+x,cur.y+y,cur.t);
}

/* ===== 進行 ===== */
function stepDown(){ if(!coll(cur.m,cur.x,cur.y+1)) cur.y++; else { merge(); } }
let last=0, acc=0;
function loop(ts){
  if(!last) last=ts; const dt=ts-last; last=ts;
  const gravity=520; acc+=dt; if(acc>=gravity){ acc=0; stepDown(); }
  render(); requestAnimationFrame(loop);
}

/* ===== 操作 ===== */
addEventListener('keydown',e=>{
  if(e.code==='ArrowLeft' && !coll(cur.m,cur.x-1,cur.y)) cur.x--;
  if(e.code==='ArrowRight'&& !coll(cur.m,cur.x+1,cur.y)) cur.x++;
  if(e.code==='ArrowDown') stepDown();
  if(e.code==='ArrowUp'){ const r=rot(cur.m); if(!coll(r,cur.x,cur.y)) cur.m=r; }
  if(e.code==='Space'){ while(!coll(cur.m,cur.x,cur.y+1)) cur.y++; merge(); }
});

/* ===== BGM再生 ===== */
const bgm = document.getElementById("bgm");
document.body.addEventListener("click", ()=>{ bgm.play(); }, {once:true});

/* ===== スタート ===== */
requestAnimationFrame(loop);
</script>
</body>
</html>
