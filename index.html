<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>ustarp969GAME – Random Platform & Tint</title>
<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#cfeeff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  #wrap{position:fixed;inset:0}
  #bg,#stage{position:absolute;inset:0;margin:auto;touch-action:none;display:block}
  #bg{z-index:1}
  #stage{z-index:2}
  #hud{position:fixed;top:10px;left:10px;right:10px;z-index:10;display:flex;justify-content:space-between;align-items:center;color:#123}
  #tip{font-size:13px;opacity:.75;margin-left:8px}
  button{border:none;border-radius:12px;padding:10px 14px;font-weight:800}
  #drop{background:#ff5c97;color:#fff;margin-right:6px}
  #retry{background:#79c6ff;color:#003}
  #title{position:fixed;inset:auto 0 40px 0;text-align:center;font-weight:900;font-size:28px;color:#fff;text-shadow:0 3px 10px #0004;z-index:3;pointer-events:none}
  #gate{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.15);color:#fff;font-weight:900;font-size:28px;text-shadow:0 3px 12px #0008;z-index:8}
  #gameover{position:fixed;inset:0;display:none;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:40px;text-shadow:0 4px 16px #0008;z-index:7;pointer-events:none}
</style>
</head>
<body>
<div id="hud">
  <div><span id="score">SCORE 0</span><span id="tip">　タップでサウンド解放 / スワイプで移動 → DROPボタンで落とす</span></div>
  <div>
    <button id="drop">DROP</button>
    <button id="retry">Retry</button>
  </div>
</div>

<div id="wrap">
  <canvas id="bg" width="420" height="720"></canvas>
  <canvas id="stage" width="420" height="720"></canvas>
</div>
<div id="title">ustarp969GAME</div>
<div id="gate">TAP TO ENABLE SOUND</div>
<div id="gameover">GAME OVER</div>

<script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
<script>
/* ===== サイズ・背景 ===== */
const W=420, H=720;
const bg=document.getElementById('bg'), bctx=bg.getContext('2d');
function drawBG(t=0){
  const g=bctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,"#bfe7ff"); g.addColorStop(0.55,"#e9f6ff"); g.addColorStop(1,"#ffe3f0");
  bctx.fillStyle=g; bctx.fillRect(0,0,W,H);
  bctx.globalAlpha=.65;
  for(let i=0;i<5;i++){
    const x=(t*12+i*120)%(W+160)-80, y=60+i*46;
    bctx.fillStyle="#fff";
    bctx.beginPath();
    bctx.ellipse(x,y,38,18,0,0,Math.PI*2);
    bctx.ellipse(x+24,y+6,26,12,0,0,Math.PI*2);
    bctx.ellipse(x-22,y+8,22,10,0,0,Math.PI*2);
    bctx.fill();
  }
  bctx.globalAlpha=1;
  bctx.save(); bctx.translate(W/2,H-42);
  bctx.fillStyle="rgba(0,0,0,.12)";
  bctx.font="900 22px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif";
  bctx.textAlign="center"; bctx.fillText("ustarp969GAME",0,0);
  bctx.restore();
}
(function loop(){ drawBG(performance.now()/1000); requestAnimationFrame(loop); })();

/* ===== オーディオ（音量さらにUP） ===== */
let actx=null, master=null;
function initAudio(){
  if(actx) return;
  const AC=window.AudioContext||window.webkitAudioContext;
  actx=new AC();
  master=actx.createGain();
  master.gain.value=0.5; // ★BGM/SE 全体音量アップ
  master.connect(actx.destination);
  // iOS解放
  const buf=actx.createBuffer(1,1,actx.sampleRate);
  const src=actx.createBufferSource(); src.buffer=buf; src.connect(master); src.start();
  actx.resume && actx.resume();
  startBGM();
}
function blip(freq,len=.25,vol=.28,type='triangle'){
  if(!actx) return;
  const o=actx.createOscillator(), g=actx.createGain();
  o.type=type; o.frequency.value=freq; o.connect(g); g.connect(master);
  const t=actx.currentTime;
  g.gain.setValueAtTime(0.0001,t);
  g.gain.exponentialRampToValueAtTime(vol,t+0.02);
  g.gain.exponentialRampToValueAtTime(0.0001,t+len);
  o.start(t); o.stop(t+len+0.02);
}
function sfxDrop(){ blip(260,0.20,0.40,'square'); blip(520,0.12,0.26,'triangle'); }
function sfxLand(){ blip(180,0.14,0.32,'sawtooth'); }
function sfxOver(){ blip(200,0.5,0.38,'triangle'); blip(120,0.6,0.34,'sine'); }
function startBGM(){
  if(!actx) return;
  const base=261.63; const seq=[0,2,4,7,9,7,4,2, 0,5,7,9,12,9,7,5]; let i=0;
  (function loop(){
    if(!actx) return;
    blip(base*Math.pow(2,seq[i%seq.length]/12), .34, .22, 'triangle');
    if(i%4===0) blip(base/2, .50, .16, 'sine');
    i++; setTimeout(loop, 340);
  })();
}
document.getElementById('gate').addEventListener('pointerdown',(e)=>{
  e.preventDefault(); initAudio(); e.currentTarget.style.display='none';
},{passive:false});

/* ===== Matter.js ===== */
const {Engine,Render,Runner,World,Bodies,Body,Events,Composite,Vertices}=Matter;
const stage=document.getElementById('stage');
const engine=Engine.create({gravity:{x:0,y:.95}});
const render=Render.create({canvas:stage,engine,options:{width:W,height:H,wireframes:false,background:'transparent'}});
Render.run(render); Runner.run(Runner.create(),engine);

/* ---- 壁（左右） ---- */
const wallL=Bodies.rectangle(-20,H/2,40,H,{isStatic:true,render:{visible:false}});
const wallR=Bodies.rectangle(W+20,H/2,40,H,{isStatic:true,render:{visible:false}});
World.add(engine.world,[wallL,wallR]);

/* ===== ランダム台（形パターン） ===== */
let platformBodies=[];
function addBodies(arr){ World.add(engine.world, arr); platformBodies=arr; }
function removePlatform(){ platformBodies.forEach(b=>World.remove(engine.world,b)); platformBodies=[]; }

function makePlatform(type){
  if(type==='flat'){ // フラットな長台
    const base=Bodies.rectangle(W/2, 600, 260, 18, {isStatic:true, render:{fillStyle:"#2f2f2f",strokeStyle:"#000",lineWidth:2}});
    return [base];
  }
  if(type==='wedge'){ // ちょい傾斜の台 ×2
    const a=Bodies.rectangle(W/2-60, 605, 130, 16, {isStatic:true, angle:-0.06, render:{fillStyle:"#3a3a3a",strokeStyle:"#000",lineWidth:2}});
    const b=Bodies.rectangle(W/2+60, 605, 130, 16, {isStatic:true, angle: 0.06, render:{fillStyle:"#3a3a3a",strokeStyle:"#000",lineWidth:2}});
    return [a,b];
  }
  if(type==='bumpy'){ // デコボコ台
    const verts=Vertices.fromPath("-120 0 -80 -10 -40 0 0 -8 40 0 80 -12 120 0 120 12 -120 12");
    const pv=Bodies.fromVertices(W/2,600,verts,{isStatic:true, render:{fillStyle:"#2c2c2c",strokeStyle:"#000",lineWidth:2}});
    return [pv];
  }
  // 既存バイク台
  const bikeVerts=Vertices.fromPath("0 0  70 -16  110 -8  140 -18  170 -6  200 -12  230 0  180 16  120 14  60 10");
  const bike=Bodies.fromVertices(W/2,560,bikeVerts,{isStatic:true, render:{fillStyle:"#2f2f2f",strokeStyle:"#000",lineWidth:2}});
  const wheelL=Bodies.circle(W/2-60,590,24,{isStatic:true,render:{fillStyle:"#4a4a4a",strokeStyle:"#000",lineWidth:2}});
  const wheelR=Bodies.circle(W/2+90,590,24,{isStatic:true,render:{fillStyle:"#4a4a4a",strokeStyle:"#000",lineWidth:2}});
  return [bike,wheelL,wheelR];
}
const PLATFORM_TYPES=['bike','flat','wedge','bumpy'];
function pickPlatform(){ return PLATFORM_TYPES[(Math.random()*PLATFORM_TYPES.length)|0]; }
function setRandomPlatform(){ removePlatform(); addBodies(makePlatform(pickPlatform())); }
setRandomPlatform(); // 初回

/* ===== 画像プリロード ===== */
const ASSETS=["I.PNG","O.PNG","T.PNG","L.PNG","J.PNG","S.PNG"];
function preload(list){
  return Promise.all(list.map(name=>new Promise(res=>{
    const img=new Image();
    img.onload=()=>res({ok:true,name,img,w:img.naturalWidth,h:img.naturalHeight,src:"./"+name});
    img.onerror=()=>res({ok:false,name,w:80,h:100,src:"./"+name});
    img.src="./"+name+"?v=4";
  })));
}

/* ===== テクスチャ着色（色ランダム） ===== */
const PALETTE = ["#ff7aa2","#ffd166","#7bdff2","#b8f7d4","#c3a6ff","#ffbd59","#9cff7a","#ff9cee"];
function tintTexture(img, color){
  // オフスクリーンで色乗せ（アルファ保持）
  const w=img.naturalWidth, h=img.naturalHeight;
  const c=document.createElement('canvas'); c.width=w; c.height=h;
  const ctx=c.getContext('2d');
  ctx.drawImage(img,0,0);
  ctx.globalCompositeOperation='source-atop';
  ctx.fillStyle=color;
  ctx.fillRect(0,0,w,h);
  ctx.globalCompositeOperation='destination-in';
  ctx.drawImage(img,0,0);
  return c.toDataURL(); // dataURLをスプライトテクスチャに
}

/* ===== ゲーム ===== */
const MAX_W=44; // ★小さくして難易度ダウン
let photos=[], qi=0, cur=null, followX=W/2, isDrag=false, score=0, over=false, drops=0;
const scoreEl=document.getElementById('score');
const overEl=document.getElementById('gameover');

function setScore(n){ score=n; scoreEl.textContent="SCORE "+score; }

function makeBody(p,x,y,isStatic=true){
  const ratio=p.h/p.w, w=Math.min(MAX_W, p.w||MAX_W), h=w*ratio;
  const opt={ isStatic, restitution:0.08, friction:0.7 };
  if(p.ok){
    // ランダム色で着色したテクスチャを生成
    const color = PALETTE[(Math.random()*PALETTE.length)|0];
    const tex = tintTexture(p.img, color);
    opt.render = { sprite:{ texture:tex, xScale:w/p.w, yScale:h/p.h } };
  }else{
    opt.render={ fillStyle:"#ffb3d1", strokeStyle:"#c03", lineWidth:1.5 };
  }
  return Bodies.rectangle(x,y,w,h,opt);
}

function spawn(){
  if(over) return;
  const p = photos[qi++ % photos.length];
  cur = makeBody(p, followX, 80, true);
  World.add(engine.world, cur);
}

function drop(){
  if(!cur || over) return;
  Body.setStatic(cur,false);
  sfxDrop();
  cur=null; setScore(score+1);
  drops++;
  // 5個ごとに台をランダム変更して変化を出す
  if(drops % 5 === 0){ setRandomPlatform(); }
  setTimeout(spawn, 480);
}

/* 完全リセット（台は毎回ランダム） */
function reset(){
  // まず全ボディを除去
  Composite.allBodies(engine.world).forEach(b=>World.remove(engine.world,b));
  // 壁を戻す
  World.add(engine.world,[wallL,wallR]);
  // ランダム台を入れ直す
  setRandomPlatform();
  qi=0; over=false; isDrag=false; drops=0; setScore(0);
  overEl.style.display='none';
  spawn();
}

/* ===== 入力（押してる間は“ぴったり”、離すとイーズ） ===== */
stage.addEventListener('pointerdown',(e)=>{
  isDrag=true;
  const r=stage.getBoundingClientRect();
  followX = Math.max(30, Math.min(W-30, (e.clientX-r.left)*(W/r.width)));
},{passive:true});
stage.addEventListener('pointermove',(e)=>{
  if(!isDrag) return;
  const r=stage.getBoundingClientRect();
  followX = Math.max(30, Math.min(W-30, (e.clientX-r.left)*(W/r.width)));
},{passive:true});
stage.addEventListener('pointerup',()=>{ isDrag=false; },{passive:true});
stage.addEventListener('pointercancel',()=>{ isDrag=false; },{passive:true});

/* ★DROPはボタンだけ（サウンド解放も兼ねる） */
document.getElementById('drop').addEventListener('click',()=>{
  initAudio(); drop();
});
document.getElementById('retry').addEventListener('click',()=>{
  initAudio(); reset();
});

/* ===== 物理更新 ===== */
Events.on(engine,'beforeUpdate',()=>{
  if(cur && cur.isStatic){
    if(isDrag){
      Body.setPosition(cur, {x:followX, y:cur.position.y});
    }else{
      const speed=0.45; // イーズ速度
      Body.setPosition(cur, {x:cur.position.x+(followX-cur.position.x)*speed, y:cur.position.y});
    }
  }
});
Events.on(engine,'afterUpdate',()=>{
  const fallen = Composite.allBodies(engine.world).find(b=>!b.isStatic && b.position.y>660);
  if(fallen && !over){ over=true; sfxOver(); overEl.style.display='flex'; }
});
Events.on(engine,'collisionStart', (ev)=>{
  ev.pairs.forEach(p=>{
    const a=p.bodyA, b=p.bodyB;
    const dynStatic = (!a.isStatic && b.isStatic) || (!b.isStatic && a.isStatic);
    if(dynStatic && p.collision.depth>0.15) sfxLand();
  });
});

/* ===== スタート ===== */
preload(ASSETS).then(list=>{ photos=list; setScore(0); spawn(); });
</script>
</body>
</html>
