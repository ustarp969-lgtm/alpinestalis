<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>ustarp969GAME – SE Fixed Ver</title>
<style>
html,body{margin:0;height:100%;overflow:hidden;background:#cfeeff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
#wrap{position:fixed;inset:0}
#bg,#stage{position:absolute;inset:0;touch-action:none;display:block}
#bg{z-index:1} #stage{z-index:2}
#hud{position:fixed;top:10px;left:10px;right:10px;z-index:3;display:flex;justify-content:space-between;align-items:center;color:#123}
#tip{font-size:13px;opacity:.75;margin-left:8px}
button{border:none;border-radius:12px;padding:10px 14px;font-weight:800}
#drop{background:#ff5c97;color:#fff;margin-right:6px}
#retry{background:#79c6ff;color:#003}
#title{position:fixed;inset:auto 0 40px 0;text-align:center;font-weight:900;font-size:28px;color:#fff;text-shadow:0 3px 10px #0004;z-index:1;pointer-events:none}
#overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35);color:#fff;font-weight:900;font-size:40px;z-index:4;text-shadow:0 3px 12px #0008}
</style>
</head>
<body>
<div id="hud">
  <div>
    <span id="score">スコア 0</span>
    <span id="tip">　スワイプで移動 → 「落とす」でドロップ</span>
  </div>
  <div>
    <button id="drop">落とす</button>
    <button id="retry">やり直し</button>
  </div>
</div>

<div id="wrap">
  <canvas id="bg" width="420" height="720"></canvas>
  <canvas id="stage" width="420" height="720"></canvas>
</div>
<div id="title">ustarp969GAME</div>
<div id="overlay"></div>

<script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
<script>
const W=420, H=720;

/* === 背景 === */
const bg=document.getElementById("bg"),bctx=bg.getContext("2d");
function drawBG(t=0){
  const g=bctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,"#bfe7ff");g.addColorStop(1,"#ffe3f0");
  bctx.fillStyle=g;bctx.fillRect(0,0,W,H);
  bctx.globalAlpha=.6;
  for(let i=0;i<5;i++){
    const x=(t*12+i*120)%(W+160)-80,y=60+i*46;
    bctx.fillStyle="#fff";
    bctx.beginPath();
    bctx.ellipse(x,y,38,18,0,0,Math.PI*2);
    bctx.ellipse(x+24,y+6,26,12,0,0,Math.PI*2);
    bctx.ellipse(x-22,y+8,22,10,0,0,Math.PI*2);
    bctx.fill();
  }
  bctx.globalAlpha=1;
  bctx.font="900 22px system-ui";
  bctx.fillStyle="rgba(0,0,0,.12)";
  bctx.textAlign="center";
  bctx.fillText("ustarp969GAME",W/2,H-42);
}
(function loop(){drawBG(performance.now()/1000);requestAnimationFrame(loop);})();

/* === オーディオ === */
let actx=null,master=null;
function initAudio(){
  if(actx)return;
  const AC=window.AudioContext||window.webkitAudioContext;
  actx=new AC();
  master=actx.createGain();master.gain.value=.4;master.connect(actx.destination);

  // BGMループ
  const base=261.63,seq=[0,2,4,7,9,7,4,2,0,5,7,9,12,9,7,5];let i=0;
  function note(semi,len=.36,vol=.08,type='triangle'){
    const o=actx.createOscillator(),g=actx.createGain();
    o.type=type;o.frequency.value=base*Math.pow(2,semi/12);
    o.connect(g);g.connect(master);
    const t=actx.currentTime;
    g.gain.setValueAtTime(.0001,t);
    g.gain.exponentialRampToValueAtTime(vol,t+.03);
    g.gain.exponentialRampToValueAtTime(.0001,t+len);
    o.start(t);o.stop(t+len+.02);
  }
  (function seqLoop(){note(seq[i%seq.length]);if(i%4===0)note(-12,.5,.08,'sine');i++;setTimeout(seqLoop,340);})();
}

// 効果音
function se(freq=440,dur=.25,vol=.3,type='square'){
  if(!actx)return;
  const o=actx.createOscillator(),g=actx.createGain();
  o.type=type;o.frequency.value=freq;
  o.connect(g);g.connect(master);
  g.gain.setValueAtTime(vol,actx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+dur);
  o.start();o.stop(actx.currentTime+dur);
}

/* === Matter.js === */
const {Engine,Render,Runner,World,Bodies,Body,Events,Composite}=Matter;
const stage=document.getElementById("stage");
const engine=Engine.create({gravity:{x:0,y:.95}});
const render=Render.create({canvas:stage,engine,options:{width:W,height:H,wireframes:false,background:'transparent'}});
Render.run(render);
Runner.run(Runner.create(),engine);

// 台
const deck=Bodies.rectangle(W/2,600,260,14,{isStatic:true,render:{fillStyle:"#2f2f2f"}});
const wheelL=Bodies.circle(W/2-90,630,24,{isStatic:true,render:{fillStyle:"#3a3a3a"}});
const wheelR=Bodies.circle(W/2+90,630,24,{isStatic:true,render:{fillStyle:"#3a3a3a"}});
World.add(engine.world,[deck,wheelL,wheelR]);
// 壁
World.add(engine.world,[
  Bodies.rectangle(-20,H/2,40,H,{isStatic:true,render:{visible:false}}),
  Bodies.rectangle(W+20,H/2,40,H,{isStatic:true,render:{visible:false}})
]);

/* === 画像ロード === */
const FILES=["I","O","T","L","J","S"];
async function loadOne(name){
  const tryList=[`./${name}.PNG`,`./${name}.png`];
  for(const src of tryList){
    const ok=await new Promise(res=>{
      const img=new Image();
      img.onload=()=>res({ok:true,src,w:img.naturalWidth,h:img.naturalHeight});
      img.onerror=()=>res(null);
      img.src=src+"?v=6";
    });
    if(ok)return ok;
  }
  return{ok:false,src:null,w:60,h:90};
}
async function preload(){
  const arr=[];
  for(const n of FILES){arr.push(await loadOne(n));}
  return arr;
}

/* === ゲーム === */
const MAX_W=56;
let photos=[],qi=0,cur=null,followX=W/2,score=0,over=false;
const scoreEl=document.getElementById("score");
const overlay=document.getElementById("overlay");
function setScore(n){score=n;scoreEl.textContent="スコア "+score;}
function showOverlay(text,ms=900){overlay.textContent=text;overlay.style.display="grid";setTimeout(()=>overlay.style.display="none",ms);}

function makeBody(pic,x,y,isStatic=true){
  const ratio=pic.h/pic.w;const w=Math.min(MAX_W,pic.w||MAX_W),h=w*ratio;
  const opt={isStatic,restitution:0.08,friction:0.7};
  if(pic.ok&&pic.src){opt.render={sprite:{texture:pic.src,xScale:w/(pic.w||w),yScale:h/(pic.h||h)}};}
  else{opt.render={fillStyle:"#ffb3d1"};}
  return Bodies.rectangle(x,y,w,h,opt);
}

function spawn(){if(over)return;const p=photos[qi++%photos.length];cur=makeBody(p,followX,80,true);World.add(engine.world,cur);}
function drop(){if(!cur||over)return;Body.setStatic(cur,false);se(880,.1);cur=null;setScore(score+1);setTimeout(spawn,600);}
function reset(){
  Composite.allBodies(engine.world).forEach(b=>{if(![deck,wheelL,wheelR].includes(b))World.remove(engine.world,b);});
  qi=0;over=false;setScore(0);showOverlay("さぁいきますん。",700);spawn();
}

/* === 入力 === */
stage.addEventListener("pointermove",e=>{
  const r=stage.getBoundingClientRect();
  followX=Math.max(30,Math.min(W-30,(e.clientX-r.left)*(W/r.width)));
});
document.getElementById("drop").onclick=()=>{drop();};
document.getElementById("retry").onclick=()=>{se(220,.2);reset();};

/* === 物理 === */
Events.on(engine,"beforeUpdate",()=>{
  if(cur&&cur.isStatic){Body.setPosition(cur,{x:cur.position.x+(followX-cur.position.x)*0.25,y:cur.position.y});}
});
Events.on(engine,"afterUpdate",()=>{
  const fallen=Composite.allBodies(engine.world).find(b=>!b.isStatic&&b.position.y>690);
  if(fallen&&!over){over=true;se(200,.4);showOverlay("おわた。",1000);}
});

/* === スタート === */
document.body.addEventListener("pointerdown",()=>{initAudio();},{once:true});
preload().then(list=>{photos=list;setScore(0);showOverlay("さぁいきますん。",700);spawn();});
</script>
</body>
</html>
