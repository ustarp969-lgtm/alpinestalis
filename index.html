<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>ustarp969GAME – さぁいきますん。</title>
<style>
html,body{margin:0;height:100%;overflow:hidden;background:#cfeeff;
font-family:"Noto Sans JP","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;}
#wrap{position:fixed;inset:0}
#bg,#stage{
  position:absolute; inset:0; margin:auto; display:block; touch-action:none;
}
#bg{z-index:1}
#stage{z-index:2}
#hud{position:fixed;top:10px;left:10px;right:10px;z-index:3;
display:flex;justify-content:space-between;align-items:center;color:#123}
#tip{font-size:13px;opacity:.75;margin-left:8px}
button{border:none;border-radius:12px;padding:10px 14px;font-weight:800}
#drop{background:#ff5c97;color:#fff;margin-right:6px}
#retry{background:#79c6ff;color:#003}
#title{position:fixed;inset:auto 0 40px 0;text-align:center;font-weight:900;
font-size:28px;color:#fff;text-shadow:0 3px 10px #0004;z-index:1;pointer-events:none}
#startMsg,#overMsg{
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
  font-size:40px;font-weight:900;z-index:5;text-shadow:0 3px 10px #0008;pointer-events:none;
  opacity:0;transition:opacity 0.5s ease;
}
#startMsg{color:#fff;}
#overMsg{color:#ff4040;}
.show{opacity:1;}
</style>
</head>
<body>
<div id="hud">
  <div><span id="score">スコア 0</span><span id="tip">　スワイプで移動 → 「落とす」でドロップ</span></div>
  <div>
    <button id="drop">落とす</button>
    <button id="retry">やり直し</button>
  </div>
</div>

<div id="wrap">
  <canvas id="bg" width="420" height="720"></canvas>
  <canvas id="stage" width="420" height="720"></canvas>
</div>
<div id="title">ustarp969GAME</div>

<div id="startMsg">さぁいきますん。</div>
<div id="overMsg">おわた。</div>

<script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
<script>
const W=420,H=720;
const bg=document.getElementById('bg'),bctx=bg.getContext('2d');
function drawBG(t=0){
 const g=bctx.createLinearGradient(0,0,0,H);
 g.addColorStop(0,"#bfe7ff"); g.addColorStop(0.55,"#e9f6ff"); g.addColorStop(1,"#ffe3f0");
 bctx.fillStyle=g; bctx.fillRect(0,0,W,H);
 bctx.globalAlpha=.6;
 for(let i=0;i<5;i++){
   const x=(t*12+i*120)%(W+160)-80, y=60+i*46;
   bctx.fillStyle="#fff";
   bctx.beginPath();
   bctx.ellipse(x,y,38,18,0,0,Math.PI*2);
   bctx.ellipse(x+24,y+6,26,12,0,0,Math.PI*2);
   bctx.ellipse(x-22,y+8,22,10,0,0,Math.PI*2);
   bctx.fill();
 }
 bctx.globalAlpha=1;
}
(function loop(){drawBG(performance.now()/1000);requestAnimationFrame(loop);})();

/* ===== Audio ===== */
let actx=null, master=null;
const AC=window.AudioContext||window.webkitAudioContext;
function initAudio(){
 if(actx)return;
 actx=new AC();
 master=actx.createGain(); master.gain.value=.35;
 master.connect(actx.destination);
 const base=261.63; const seq=[0,2,4,7,9,7,4,2,0,5,7,9,12,9,7,5]; let i=0;
 function note(semi,len=.36,vol=.1,type='triangle'){
  const o=actx.createOscillator(), g=actx.createGain();
  o.type=type; o.frequency.value=base*Math.pow(2,semi/12);
  o.connect(g); g.connect(master);
  const t=actx.currentTime;
  g.gain.setValueAtTime(.0001,t);
  g.gain.exponentialRampToValueAtTime(vol,t+.03);
  g.gain.exponentialRampToValueAtTime(.0001,t+len);
  o.start(t); o.stop(t+len+.02);
 }
 (function loop(){note(seq[i%seq.length]);if(i%4===0)note(-12,.5,.1,'sine');i++;setTimeout(loop,340);})();
}

/* ===== Matter.js ===== */
const {Engine,Render,Runner,World,Bodies,Body,Events,Composite}=Matter;
const stage=document.getElementById('stage');
const engine=Engine.create({gravity:{x:0,y:.95}});
const render=Render.create({canvas:stage,engine,options:{width:W,height:H,wireframes:false,background:'transparent'}});
Render.run(render); Runner.run(Runner.create(),engine);

/* ---- 台 ---- */
const base=Bodies.rectangle(W/2,600,220,20,{isStatic:true,render:{fillStyle:"#444"}});
World.add(engine.world,[base]);

/* ---- 状態 ---- */
let cur=null,followX=W/2,score=0,over=false;
const scoreEl=document.getElementById('score');
function setScore(n){score=n;scoreEl.textContent="スコア "+score;}

/* ---- ブロック生成 ---- */
function makeBox(){
 const size=40;
 const colors=["#ff7b7b","#7bffb0","#7bb3ff","#fff07b"];
 const color=colors[Math.floor(Math.random()*colors.length)];
 return Bodies.rectangle(W/2,100,size,size,{render:{fillStyle:color}});
}

/* ---- スポーン・落下 ---- */
function spawn(){
 if(over)return;
 cur=makeBox();
 World.add(engine.world,cur);
}

function drop(){
 if(!cur||over)return;
 Body.setStatic(cur,false);
 cur=null;
 setScore(score+1);
 setTimeout(spawn,600);
}

function reset(){
 World.clear(engine.world,false);
 World.add(engine.world,[base]);
 score=0;over=false;setScore(0);
 spawn();
 showStart();
}

stage.addEventListener('pointermove',e=>{
 const r=stage.getBoundingClientRect();
 followX=Math.max(30,Math.min(W-30,(e.clientX-r.left)*(W/r.width)));
});
document.getElementById('drop').onclick=drop;
document.getElementById('retry').onclick=reset;

/* ---- 移動と判定 ---- */
Events.on(engine,'beforeUpdate',()=>{
 if(cur&&cur.isStatic){
   Body.setPosition(cur,{x:cur.position.x+(followX-cur.position.x)*0.35,y:cur.position.y});
 }
});
Events.on(engine,'afterUpdate',()=>{
 const fallen=Composite.allBodies(engine.world).find(b=>!b.isStatic&&b.position.y>700);
 if(fallen&&!over){
   over=true;
   document.getElementById('overMsg').classList.add('show');
   setTimeout(()=>document.getElementById('overMsg').classList.remove('show'),2000);
 }
});

/* ---- スタート演出 ---- */
function showStart(){
 const el=document.getElementById('startMsg');
 el.classList.add('show');
 setTimeout(()=>el.classList.remove('show'),1000);
}

document.body.addEventListener('pointerdown',()=>{initAudio();},{once:true});
showStart();
spawn();
</script>
</body>
</html>
