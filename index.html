<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Rider Balance – モトクロスバランスゲーム</title>
<style>
  html,body{margin:0;height:100%;overflow:hidden;background:linear-gradient(180deg,#d0f3ff 0%,#fef9ff 100%);}
  canvas{display:block;margin:0 auto;touch-action:none;}
  #hud{position:fixed;top:10px;left:10px;right:10px;display:flex;align-items:center;justify-content:space-between;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#333;z-index:10;}
  button{border:none;border-radius:10px;padding:8px 14px;font-weight:700;margin-left:6px;}
  #dropBtn{background:#ff6394;color:white;}
  #retryBtn{background:#75c4ff;color:#023;}
  #msg{font-weight:700;}
</style>
</head>
<body>
<div id="hud">
  <div id="score">SCORE 0</div>
  <div id="msg">タップでBGM / スワイプで移動 → DROPで落とす！</div>
  <div>
    <button id="dropBtn">DROP</button>
    <button id="retryBtn">Retry</button>
  </div>
</div>
<canvas id="stage" width="420" height="720"></canvas>

<script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
<script>
/* === 設定 === */
const FILES = ["I.PNG","O.PNG","T.PNG","L.PNG","J.PNG","S.PNG"];
const MAX_PHOTO_W = 70; // ★ 小さめキャラ
const CANVAS_W = 420, CANVAS_H = 720;
const GRAVITY_Y = 0.9;

/* === BGM === */
let actx=null, master=null;
function playBgm(){
  if(actx) return;
  const AC = window.AudioContext||window.webkitAudioContext;
  actx = new AC(); master = actx.createGain(); master.gain.value=.12; master.connect(actx.destination);
  const seq=[0,2,4,7,9,7,4,2, 0,5,7,9,12,9,7,5];
  const base=261.63; let i=0;
  function note(semi,dur=.35,gain=.15,type='triangle'){
    const o=actx.createOscillator(), g=actx.createGain();
    o.type=type; o.frequency.value=base*Math.pow(2,semi/12);
    o.connect(g); g.connect(master);
    const t=actx.currentTime;
    g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(gain,t+.03);
    g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
    o.start(t); o.stop(t+dur+.02);
  }
  function loop(){
    note(seq[i%seq.length],.38,.13,'triangle');
    i++; setTimeout(loop,360);
  }
  loop();
}
addEventListener('pointerdown',()=>playBgm(),{once:true});

/* === 物理エンジン === */
const {Engine,Render,Runner,World,Bodies,Body,Events,Composite,Vertices} = Matter;
const engine=Engine.create({gravity:{x:0,y:GRAVITY_Y}});
const world=engine.world;
const canvas=document.getElementById('stage');
const render=Render.create({
  canvas,engine,
  options:{width:CANVAS_W,height:CANVAS_H,wireframes:false,background:'transparent'}
});
Render.run(render);
Runner.run(Runner.create(),engine);

/* === モトクロス台 === */
// モトクロスの形（ポリゴン）
const bikeVertices = Vertices.fromPath("0 0  50 -10  80 -5  100 -15  120 -5  140 -10  160 0  120 15  80 15  40 10");
const bike = Bodies.fromVertices(CANVAS_W/2, 580, bikeVertices, {
  isStatic:true, render:{fillStyle:"#2b2b2b",strokeStyle:"#111",lineWidth:2}
});
const wheels = [
  Bodies.circle(CANVAS_W/2-40,600,20,{isStatic:true,render:{fillStyle:"#444"}}),
